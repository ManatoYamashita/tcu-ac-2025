name: Feature Branch CI

on:
  push:
    branches-ignore:
      - main
    paths-ignore:
      - 'docs/**'
      - '**.md'
      - '.gitignore'

permissions:
  contents: write
  pull-requests: write

jobs:
  lint-and-build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Lint
        run: npm run lint

      - name: Run Build
        run: npm run build

  create-pr:
    needs: lint-and-build
    if: success()
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract branch information
        id: branch_info
        run: |
          BRANCH_NAME=$(echo ${GITHUB_REF#refs/heads/})
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

          # ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’æŠ½å‡ºï¼ˆfeature/user-dashboard â†’ FEATUREï¼‰
          PREFIX=$(echo $BRANCH_NAME | cut -d'/' -f1 | tr '[:lower:]' '[:upper:]')
          BRANCH_SUFFIX=${BRANCH_NAME#*/}

          echo "prefix=$PREFIX" >> $GITHUB_OUTPUT
          echo "branch_suffix=$BRANCH_SUFFIX" >> $GITHUB_OUTPUT

          # PRã‚¿ã‚¤ãƒˆãƒ«
          PR_TITLE="$PREFIX: $BRANCH_SUFFIX"
          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT

          # æœ€æ–°ã‚³ãƒŸãƒƒãƒˆSHAï¼ˆçŸ­ç¸®ç‰ˆï¼‰
          COMMIT_SHA=$(git rev-parse --short HEAD)
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT

      - name: Check for existing PR
        id: check_pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          EXISTING_PR=$(gh pr list \
            --head ${{ steps.branch_info.outputs.branch_name }} \
            --base main \
            --json number \
            --jq '.[0].number')

          if [ -n "$EXISTING_PR" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
            echo "::notice::PR #$EXISTING_PR already exists for this branch"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check_pr.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr create \
            --title "${{ steps.branch_info.outputs.pr_title }}" \
            --body "$(cat <<'EOF'
          ## è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

          ### ãƒ–ãƒ©ãƒ³ãƒæƒ…å ±
          - **ã‚½ãƒ¼ã‚¹:** ${{ steps.branch_info.outputs.branch_name }}
          - **ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ:** main
          - **æœ€æ–°ã‚³ãƒŸãƒƒãƒˆ:** ${{ steps.branch_info.outputs.commit_sha }}

          ### CIæ¤œè¨¼çµæžœ
          âœ… Lint: æˆåŠŸ
          âœ… Build: æˆåŠŸ

          ### å¤‰æ›´å†…å®¹
          ã“ã®PRã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚è©³ç´°ã¯ã‚³ãƒŸãƒƒãƒˆå±¥æ­´ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

          ---
          ðŸ¤– Generated by [GitHub Actions](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF
          )" \
            --base main \
            --head ${{ steps.branch_info.outputs.branch_name }} \
            --reviewer ManatoYamashita
